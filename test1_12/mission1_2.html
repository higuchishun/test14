<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>第一ミッション</title>
  <link rel="stylesheet" href="css/style.css">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Reggae+One&display=swap" rel="stylesheet">

  <link href="https://use.fontawesome.com/releases/v6.5.2/css/all.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome-animation/0.0.10/font-awesome-animation.css" type="text/css" media="all" />
</head>
<body>
      <!-- ハンバーガーメニュー -->
      <div class="hamburger" onclick="toggleMenu()">
        <div></div>
        <div></div>
        <div></div>
      </div>
    
      <!-- メニューの内容 -->
      <div id="menu" class="menu">
        <a href="hero.html" target="_blank">ロスヒーローレベル</a>
        <a href="recipe_record.html" target="_blank">倒したフードロスエネミー</a>
    
      </div>
<h1>暴君ナス伯爵<div class = "star-level"><i class="fa-solid fa-star"></i><i class="fa-regular fa-star"></i><i class="fa-regular fa-star"></i><i class="fa-regular fa-star"></i><i class="fa-regular fa-star"></i></div></h1>
<img src = "img/eggplant.png" class="keyframe animation" alt = "poteto">
<p class="explanation">食べられる部分も過剰除去してしまう暴君ナス伯爵を発見！<br>少し身分が高いからといって、いい気になりやがって！<br>この暴君ナス伯爵を倒すためには、秘伝のアイテムを集めて、"オニオンブレード（なすうどん）"を作らねばならない！<br>オニオンブレーうどんで暴君ナス伯爵を切り裂け！</p>
<div id="checklist">
  <h2>オニオンブレードうどん（なすうどん）</h2>
  <div class = "checklist-content">
  <div class = "item1">
  <label><input type="checkbox" class="check-item" data-name="卵" data-quantity="1"> 卵 - 1個</label><br>
  <label><input type="checkbox" class="check-item" data-name="なす" data-quantity="1"> なす - 1本</label><br>
  </div>
  <div class = "item2">
  <label><input type="checkbox" class="check-item" data-name="うどん" data-quantity="1"> うどん - 1玉</label><br>
  <label><input type="checkbox" class="check-item" data-name="紅ショウガ" data-quantity="50"> 紅ショウガ - 50g</label><br>
  </div>
</div>
<details class="accordion-003">
  <summary><div><i class="fa-solid fa-key"></i>キーアイテム</div></summary>
  <p>水…1.5カップ<br>麺つゆ（2倍濃縮）…大さじ2<br>塩…適量</p>
</details>
<!-- <details class="accordion-003">
  <summary>アコーディオンのデザイン</summary>
  <p>下線だけのシンプルなアコーディオンメニュー。クセがなくどんなサイトでも使いやすいのが特徴です。</p>
</details> -->
</div>

<div class="container">
  <h3>秘伝のアイテムボックス</h3>
  <form id="ingredient-form">
    <label for="name">食材の名前:</label>
    <select id="name" name="name" required>
      <option value="" disabled selected>選択してください</option>
      <option value="卵">卵</option>
        <option value="なす">なす</option>
        <option value="うどん">うどん</option>
        <option value="紅ショウガ">紅ショウガ</option>
        <option value="other">その他 (自由入力)</option>
    </select><br>
    <label for="otherName" style="display:none;" id="otherNameLabel">食材の名前 (入力):</label>
      <input type="text" id="otherName" name="otherName" placeholder="食材の名前を入力" style="display:none;"><br>
      <label for="quantity">個数（<span id="unit-label">個</span>）:</label>
      <input type="number" id="quantity" name="quantity" step="0.5" required><br>
      <!-- 追加: 単位の自動変更に使用 -->
      <input type="hidden" id="auto-unit" name="auto-unit">

  

    <button type="submit">登録</button>
  </form>
  <div id="output"></div>

  <button id="mission-button" style="display:none;" onclick="goToSecondMission()">次へ進む</button>
</div>


<script>
  // メニュー表示の切り替え
  function toggleMenu() {
    const menu = document.getElementById('menu');
    menu.classList.toggle('active');
  }
// 食材の単位を定義
const unitMap = {
'ごはん': '合',
'卵': '個',
'長ネギ': '本',
'紅ショウガ': 'g',
'other': '' // 自由入力の場合は単位なし
};

// 単位を推定する関数（自由入力の場合）
function guessUnitByName(name) {
// 正確に一致する場合の単位を取得
if (unitMap[name]) {
    return unitMap[name];
}

// 自由入力の場合、名前の部分一致で推定
if (name.includes('卵')) return '個';
if (name.includes('ごはん') || name.includes('米')) return '合';
if (name.includes('ネギ')) return '本';
if (name.includes('紅ショウガ')) return 'g';
if (name.includes('なす')) return '個';
if (name.includes('うどん')) return '玉';
if (name.includes('牛肉')) return 'g';
if (name.includes('玉ねぎ')) return '個';
if (name.includes('ピーマン')) return '個';
if (name.includes('鶏もも')) return 'g';
if (name.includes('もやし')) return 'g';
if (name.includes('パプリカ')) return '個';
if (name.includes('にんにく')) return '片';
if (name.includes('じゃがいも')) return '個';
if (name.includes('ベーコン')) return '枚';
if (name.includes('バター')) return 'g';
if (name.includes('アスパラ')) return '本';
if (name.includes('チーズ')) return 'g';
if (name.includes('パスタ')) return 'g';
if (name.includes('しめじ')) return '個';
if (name.includes('にんじん')) return '個';
if (name.includes('里芋')) return '個';
if (name.includes('ごぼう')) return '個';
if (name.includes('こんにゃく')) return '個';
if (name.includes('舞茸')) return '個';
if (name.includes('きゃべつ')) return '個';
if (name.includes('トマト')) return '個';

// それ以外はデフォルトで「個」
return '個';
}

// 選択された食材に応じて単位を更新
document.getElementById('name').addEventListener('change', function() {
const selectedValue = this.value;
const unitLabel = document.getElementById('unit-label');
const otherNameInput = document.getElementById('otherName');
const otherNameLabel = document.getElementById('otherNameLabel');

if (selectedValue === 'other') {
    // 自由入力が選択された場合
    otherNameInput.style.display = 'block';
    otherNameLabel.style.display = 'block';
    unitLabel.textContent = '';  // 単位なし（後で入力内容から推定）
} else {
    // 選択された食材に応じて単位を更新
    otherNameInput.style.display = 'none';
    otherNameLabel.style.display = 'none';
    unitLabel.textContent = unitMap[selectedValue] || '個'; // マッピングされた単位を表示
}
});

// フォーム送信時に食材を保存し、リストに表示
document.getElementById('ingredient-form').addEventListener('submit', function(event) {
event.preventDefault();

const nameSelect = document.getElementById('name');
const selectedName = nameSelect.value;
const otherName = document.getElementById('otherName').value;
const name = selectedName === 'other' ? otherName : selectedName;

// 単位を推定
const unit = selectedName === 'other' ? guessUnitByName(otherName) : unitMap[selectedName] || '個';

// 個数を単位に基づいて設定（例: うどんは1個=1玉）
const quantity = parseFloat(document.getElementById('quantity').value);

// 入力された数量に対して単位を変更するための変数を設定
let convertedQuantity = quantity;
if (unit === '玉' && selectedName === 'other' && otherName.includes('うどん')) {
    convertedQuantity = Math.round(quantity); // うどんの場合、整数に変換
}
if (unit === 'g' && selectedName === 'other' && otherName.includes('牛肉')) {
    convertedQuantity = Math.round(quantity); // 牛肉の場合、整数に変換
}
if (unit === '個' && selectedName === 'other' && otherName.includes('玉ねぎ')) {
    convertedQuantity = Math.round(quantity); 
}
if (unit === '個' && selectedName === 'other' && otherName.includes('ピーマン')) {
    convertedQuantity = Math.round(quantity); 
}
if (unit === 'g' && selectedName === 'other' && otherName.includes('鶏もも')) {
    convertedQuantity = Math.round(quantity); 
}
if (unit === 'g' && selectedName === 'other' && otherName.includes('もやし')) {
    convertedQuantity = Math.round(quantity);
}
if (unit === '個' && selectedName === 'other' && otherName.includes('パプリカ')) {
    convertedQuantity = Math.round(quantity); 
}
if (unit === '片' && selectedName === 'other' && otherName.includes('にんにく')) {
    convertedQuantity = Math.round(quantity); 
}
if (unit === '個' && selectedName === 'other' && otherName.includes('じゃがいも')) {
    convertedQuantity = Math.round(quantity); 
}
if (unit === '枚' && selectedName === 'other' && otherName.includes('ベーコン')) {
    convertedQuantity = Math.round(quantity); 
}
if (unit === 'g' && selectedName === 'other' && otherName.includes('バター')) {
    convertedQuantity = Math.round(quantity); 
}
if (unit === '本' && selectedName === 'other' && otherName.includes('アスパラ')) {
    convertedQuantity = Math.round(quantity); 
}
if (unit === 'g' && selectedName === 'other' && otherName.includes('チーズ')) {
    convertedQuantity = Math.round(quantity); 
}
if (unit === 'g' && selectedName === 'other' && otherName.includes('パスタ')) {
    convertedQuantity = Math.round(quantity); 
}
if (unit === '個' && selectedName === 'other' && otherName.includes('しめじ')) {
    convertedQuantity = Math.round(quantity);
}
if (unit === '個' && selectedName === 'other' && otherName.includes('にんじん')) {
    convertedQuantity = Math.round(quantity);
}
if (unit === '個' && selectedName === 'other' && otherName.includes('里芋')) {
    convertedQuantity = Math.round(quantity); 
}
if (unit === '個' && selectedName === 'other' && otherName.includes('ごぼう')) {
    convertedQuantity = Math.round(quantity);
}
if (unit === '個' && selectedName === 'other' && otherName.includes('こんにゃく')) {
    convertedQuantity = Math.round(quantity);
}
if (unit === '個' && selectedName === 'other' && otherName.includes('舞茸')) {
    convertedQuantity = Math.round(quantity);
}
if (unit === '個' && selectedName === 'other' && otherName.includes('きゃべつ')) {
    convertedQuantity = Math.round(quantity);
}
if (unit === '個' && selectedName === 'other' && otherName.includes('トマト')) {
    convertedQuantity = Math.round(quantity);
}
const now = new Date();
const formattedDate = now.toLocaleString();

const ingredient = {
    name: name,
    quantity: convertedQuantity,
    unit: unit,
    date: formattedDate,
};

saveIngredient(ingredient);
document.getElementById('ingredient-form').reset();
});

// ユーザーが自由入力した際に単位を変更
document.getElementById('otherName').addEventListener('input', function() {
const otherName = this.value;
const unitLabel = document.getElementById('unit-label');

// 単位を推定して表示
const guessedUnit = guessUnitByName(otherName);
unitLabel.textContent = guessedUnit;

// 入力フィールドの値も変更する場合
document.getElementById('auto-unit').value = guessedUnit; // ユーザーに見えないフィールドとして保存
});


// 保存された食材をローカルストレージに追加
function saveIngredient(ingredient) {
let ingredients = JSON.parse(localStorage.getItem('ingredients')) || [];
const existingIngredient = ingredients.find(ing => ing.name === ingredient.name);

if (existingIngredient) {
    // 既存の食材がある場合は数量を加算
    existingIngredient.quantity += ingredient.quantity;
} else {
    // 新しい食材を追加
    ingredients.push(ingredient);
}

localStorage.setItem('ingredients', JSON.stringify(ingredients)); // ローカルストレージに保存
displayStoredIngredients();
updateChecklist(ingredient.name);
}


  // 保存された食材を表示し、チェックリストを更新
  function displayStoredIngredients() {
    const ingredients = JSON.parse(localStorage.getItem('ingredients')) || [];
    const output = document.getElementById('output');
    output.innerHTML = '';

    ingredients.forEach(ingredient => {
      const outputItem = document.createElement('div');
      outputItem.innerHTML = `
        <strong>食材名:</strong> ${ingredient.name}<br>
        <strong>数量:</strong> ${ingredient.quantity} ${ingredient.unit}<br>
        <strong>登録した日時:</strong> ${ingredient.date}<br>
        <button class="delete-button" onclick="deleteIngredient('${ingredient.name}')">削除</button><br>`;
      output.appendChild(outputItem);
    });

    // チェックリストの更新
    updateChecklist();
  }

  // チェックリストを更新する関数
  function updateChecklist() {
    const ingredients = JSON.parse(localStorage.getItem('ingredients')) || [];
    const checkboxes = document.querySelectorAll('.check-item');

    checkboxes.forEach(checkbox => {
      const ingredient = ingredients.find(ing => ing.name === checkbox.dataset.name);
      if (ingredient && ingredient.quantity >= checkbox.dataset.quantity) {
        checkbox.checked = true;
      }
    });

    // 全てのチェックボックスがチェックされたら次のミッションボタンを表示
    const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
    if (allChecked) {
      document.getElementById('mission-button').style.display = 'block';
    }
  }

  // 食材を削除する
  function deleteIngredient(name) {
    let ingredients = JSON.parse(localStorage.getItem('ingredients')) || [];
    ingredients = ingredients.filter(ing => ing.name !== name);
    localStorage.setItem('ingredients', JSON.stringify(ingredients));
    displayStoredIngredients();
    updateChecklist();
  }

// 次のミッションへ進む
function goToSecondMission() {
let ingredients = JSON.parse(localStorage.getItem('ingredients')) || [];
const checkboxes = document.querySelectorAll('.check-item');
let insufficientIngredients = '';

checkboxes.forEach(checkbox => {
    const requiredQuantity = parseFloat(checkbox.dataset.quantity); // チェックリストに必要な個数
    const ingredientIndex = ingredients.findIndex(ing => ing.name === checkbox.dataset.name); // 該当の食材を取得

    if (ingredientIndex !== -1) {
        const ingredient = ingredients[ingredientIndex];
        const currentQuantity = parseFloat(ingredient.quantity); // 保存されている食材の個数
        const difference = currentQuantity - requiredQuantity; // 保存された数から必要数を引き算

        if (difference < 0) {
            // 不足している場合の処理
            insufficientIngredients += `${ingredient.name}: ${-difference} ${ingredient.unit}不足しています。\n`; // 不足している食材を表示
        } else if (difference === 0) {
            // ちょうど必要数だけあった場合、その食材を削除
            ingredients.splice(ingredientIndex, 1); // 配列から削除
        } else {
            // 十分な量がある場合、残りの個数を更新
            ingredient.quantity = difference;
        }
    } else {
        // 該当する食材が保存されていない場合
        insufficientIngredients += `${checkbox.dataset.name}: ${requiredQuantity} ${unitMap[checkbox.dataset.name]}不足しています。\n`;
    }
});

if (insufficientIngredients) {
    // 不足している食材がある場合はアラートを表示
    alert("以下の食材が不足しています:\n" + insufficientIngredients);
} else {
    // ローカルストレージを更新し、次のミッションに進む
    localStorage.setItem('ingredients', JSON.stringify(ingredients)); // 更新後のデータを保存
    window.location.href = 'mission2_2.html'; // 次のミッションへ移動
}
}




  // ページが読み込まれたら食材を表示し、チェックリストを更新
  document.addEventListener('DOMContentLoaded', function() {
    displayStoredIngredients();
  });
</script>
</body>
</html>
